<!DOCTYPE html>
<html lang="{{ lang or 'tr' }}">
<head>
  <meta charset="UTF-8" />
  <title>{{ title or 'Norya Analiz Raporu' }}</title>
  <!-- dir: RTL for Arabic/Hebrew -->
  <style>
    @page {
      size: A4;
      margin: 20mm;
      @bottom-center {
        font-size: 9px;
        color: #64748b;
        content: "{{ page_footer | default('Bu rapor bilgilendirme amaçlıdır. Tıbbi karar için hekime danışın. — Norya', true) }}";
      }
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 11px;
      line-height: 1.5;
      color: #334155;
      margin: 0;
      padding: 0;
    }
    .header {
      border-bottom: 3px solid #e07a5f;
      padding-bottom: 12px;
      margin-bottom: 20px;
    }
    .brand-wrap { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .brand-logo { width: 56px; height: auto; max-height: 56px; object-fit: contain; flex-shrink: 0; background: #fff; }
    .brand {
      font-size: 22px;
      font-weight: 700;
      color: #e07a5f;
      letter-spacing: -0.02em;
    }
    .brand-sub {
      font-size: 10px;
      color: #64748b;
      margin-top: 2px;
    }
    .report-meta {
      margin-top: 8px;
      font-size: 10px;
      color: #64748b;
    }
    .risk-banner {
      padding: 10px 14px;
      border-radius: 6px;
      margin-bottom: 18px;
      font-size: 11px;
      font-weight: 600;
    }
    .risk-normal { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
    .risk-attention { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
    .risk-high { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
    .section-title {
      font-size: 12px;
      font-weight: 700;
      color: #0f172a;
      margin: 16px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e2e8f0;
    }
    .section-body {
      margin-bottom: 14px;
      white-space: pre-wrap;
    }
    table.biomarkers {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0 18px 0;
      font-size: 10px;
    }
    table.biomarkers th {
      text-align: left;
      padding: 8px 10px;
      background: #f1f5f9;
      color: #475569;
      font-weight: 600;
      border: 1px solid #e2e8f0;
    }
    table.biomarkers td {
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
    }
    table.biomarkers tr:nth-child(even) { background: #f8fafc; }
    .range-chart {
      max-width: 100%;
      height: auto;
      margin-top: 6px;
      display: block;
      page-break-inside: avoid;
    }
    td.chart-cell { padding: 4px 10px 14px 10px; vertical-align: top; overflow: hidden; }
    .status-normal { color: #059669; font-weight: 600; }
    .status-low { color: #d97706; font-weight: 600; }
    .status-high { color: #dc2626; font-weight: 600; }
    .status-border { color: #b45309; font-weight: 600; }
    .footer-note {
      margin-top: 24px;
      padding-top: 12px;
      border-top: 1px solid #e2e8f0;
      font-size: 9px;
      color: #64748b;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand-wrap">
      <img src="static/logo.png" alt="Norya AI" class="brand-logo" />
      <span class="brand">Norya</span>
    </div>
    <div class="brand-sub">{{ subtitle | default('Kan Tahlili Analiz Raporu — Yapay Zeka Destekli Yorum', true) }}</div>
    <div class="report-meta">{{ report_date_label | default('Rapor Tarihi', true) }}: {{ report_date }}</div>
  </div>

  {% if risk_level != 'none' %}
  <div class="risk-banner risk-{{ risk_level }}">
    {{ risk_message or risk_default_attention }}
  </div>
  {% else %}
  <div class="risk-banner risk-normal">
    {{ risk_message or risk_default_normal }}
  </div>
  {% endif %}

  {% if summary %}
  <div class="section-title">{{ summary_heading | default('Özet', true) }}</div>
  <div class="section-body">{{ summary }}</div>
  {% endif %}

  {% if biomarkers %}
  <div class="section-title">{{ biomarkers_heading | default('Biyobelirteçler ve Referans Aralıkları', true) }}</div>
  <table class="biomarkers">
    <thead>
      <tr>
        <th>{{ param | default('Parametre', true) }}</th>
        <th>{{ result | default('Sonuç', true) }}</th>
        <th>{{ unit | default('Birim', true) }}</th>
        <th>{{ ref_range | default('Referans Aralığı', true) }}</th>
        <th>{{ status | default('Durum', true) }}</th>
      </tr>
    </thead>
    <tbody>
      {% for row in biomarkers %}
      <tr>
        <td>{{ row.name }}</td>
        <td>{{ row.value }}</td>
        <td>{{ row.unit or '—' }}</td>
        <td>{{ row.reference or '—' }}</td>
        <td class="status-{{ row.status }}">{{ row.status_label }}</td>
      </tr>
      {% if row.chart_svg_base64 %}
      <tr>
        <td colspan="5" class="chart-cell">
          <img class="range-chart" src="data:image/svg+xml;base64,{{ row.chart_svg_base64 }}" alt="Referans aralığı: {{ row.name }}" />
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  {% if possible_causes %}
  <div class="section-title">{{ possible_causes_heading | default('Olası Nedenler', true) }}</div>
  <div class="section-body">{{ possible_causes }}</div>
  {% endif %}

  {% if recommendations %}
  <div class="section-title">{{ recommendations_heading | default('Öneriler', true) }}</div>
  <div class="section-body">{{ recommendations }}</div>
  {% endif %}

  {% if raw_sections %}
  {% for section in raw_sections %}
  <div class="section-title">{{ section.title }}</div>
  <div class="section-body">{{ section.body }}</div>
  {% endfor %}
  {% endif %}

  <div class="footer-note">
    {{ footer_note | default('Bu rapor Norya yapay zeka yorumlama hizmeti ile oluşturulmuştur. Teşhis veya tedavi yerine geçmez. Tıbbi kararlar için mutlaka bir hekime danışın.', true) }}
  </div>
  <div class="footer-note emr-ehr-note" style="margin-top:0.5em; font-size:0.85em; color:#475569;">
    {{ emr_ehr_note | default('EMR/EHR compatible — This report can be uploaded to hospital or clinician information systems.', true) }}
  </div>
</body>
</html>

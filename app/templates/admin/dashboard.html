{% extends "admin/base_admin.html" %}
{% block title %}Dashboard - Norya Admin{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold text-white mb-6">Dashboard</h1>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <p class="text-slate-400 text-sm">GÃ¼nlÃ¼k satÄ±ÅŸ (EUR)</p>
    <p class="text-2xl font-bold text-brand">{{ daily_sales }} â‚¬</p>
  </div>
  <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <p class="text-slate-400 text-sm">AylÄ±k satÄ±ÅŸ (EUR)</p>
    <p class="text-2xl font-bold text-brand">{{ monthly_sales }} â‚¬</p>
  </div>
  <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <p class="text-slate-400 text-sm">Toplam kullanÄ±cÄ±</p>
    <p class="text-2xl font-bold text-white">{{ total_users }}</p>
  </div>
  <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <p class="text-slate-400 text-sm">Aktif kullanÄ±cÄ± (son 2 dk)</p>
    <p class="text-2xl font-bold text-white">{{ active_users }}</p>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <p class="text-slate-400 text-sm mb-2">Ortalama analiz sÃ¼resi</p>
    <p class="text-xl text-white">{{ avg_analysis_time }}</p>
  </div>
  <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
    <p class="text-slate-400 text-sm mb-2">BaÅŸarÄ±sÄ±z Ã¶deme sayÄ±sÄ±</p>
    <p class="text-xl text-white">{{ failed_payments }}</p>
  </div>
</div>

<div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-8">
  <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
    <p class="text-slate-400 text-sm font-medium">AI Durumu</p>
    <button type="button" id="ai-refresh" class="text-xs px-3 py-1.5 rounded bg-slate-600 text-slate-200 hover:bg-slate-500">Yenile</button>
  </div>
  <p id="ai-badge" class="text-lg font-semibold text-slate-300">Kontrol ediliyorâ€¦</p>
  <p id="ai-detail" class="text-sm text-slate-500 mt-1"></p>
</div>

<!-- Son 24 ay trend grafiÄŸi: analiz sayÄ±sÄ±, satÄ±ÅŸ, yeni kullanÄ±cÄ± -->
<div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-8">
  <h2 class="text-lg font-medium text-white mb-4">Son 24 ay trendi</h2>
  <p class="text-slate-500 text-sm mb-4">Ay ay analiz sayÄ±sÄ±, satÄ±ÅŸ (EUR) ve yeni kullanÄ±cÄ± â€” yÃ¼kseliÅŸ ve durgunluk takibi.</p>
  <div class="h-80">
    <canvas id="trend-chart" aria-label="Son 24 aylÄ±k trend grafiÄŸi"></canvas>
  </div>
  <div class="flex flex-wrap gap-4 mt-3 text-xs text-slate-400">
    <span><span class="inline-block w-3 h-3 rounded-full bg-teal-400 mr-1"></span> Analiz sayÄ±sÄ±</span>
    <span><span class="inline-block w-3 h-3 rounded-full bg-amber-400 mr-1"></span> SatÄ±ÅŸ (â‚¬)</span>
    <span><span class="inline-block w-3 h-3 rounded-full bg-slate-400 mr-1"></span> Yeni kullanÄ±cÄ±</span>
  </div>
</div>

<div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
  <h2 class="text-lg font-medium text-white px-4 py-3 border-b border-slate-700">Son 10 iÅŸlem</h2>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-slate-400 border-b border-slate-700">
          <th class="px-4 py-2">Tarih</th>
          <th class="px-4 py-2">merchant_oid</th>
          <th class="px-4 py-2">KullanÄ±cÄ±</th>
          <th class="px-4 py-2">ÃœrÃ¼n</th>
          <th class="px-4 py-2">Tutar (EUR)</th>
          <th class="px-4 py-2">Durum</th>
        </tr>
      </thead>
      <tbody>
        {% for t in last_transactions %}
        <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
          <td class="px-4 py-2">{{ t.created_at }}</td>
          <td class="px-4 py-2 font-mono text-xs">{{ t.merchant_oid }}</td>
          <td class="px-4 py-2">{{ t.user_email or t.user_id }}</td>
          <td class="px-4 py-2">{{ t.product }}</td>
          <td class="px-4 py-2">{{ "%.2f"|format(t.amount_kurus / 100) }} â‚¬</td>
          <td class="px-4 py-2"><span class="{% if t.status == 'completed' %}text-green-400{% elif t.status == 'failed' %}text-red-400{% else %}text-amber-400{% endif %}">{{ t.status }}</span></td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="px-4 py-4 text-slate-500">Ä°ÅŸlem yok.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
  // Son 12 ay trend grafiÄŸi
  var trendCanvas = document.getElementById('trend-chart');
  if (trendCanvas) {
    var chartLabels = {{ chart_labels | tojson }};
    var chartAnalyses = {{ chart_analyses | tojson }};
    var chartSales = {{ chart_sales | tojson }};
    var chartUsers = {{ chart_users | tojson }};
    new Chart(trendCanvas, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [
          {
            label: 'Analiz sayÄ±sÄ±',
            data: chartAnalyses,
            borderColor: 'rgb(45, 212, 191)',
            backgroundColor: 'rgba(45, 212, 191, 0.1)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y'
          },
          {
            label: 'SatÄ±ÅŸ (â‚¬)',
            data: chartSales,
            borderColor: 'rgb(251, 191, 36)',
            backgroundColor: 'rgba(251, 191, 36, 0.1)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y1'
          },
          {
            label: 'Yeni kullanÄ±cÄ±',
            data: chartUsers,
            borderColor: 'rgb(148, 163, 184)',
            backgroundColor: 'rgba(148, 163, 184, 0.1)',
            fill: true,
            tension: 0.3,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Adet (analiz / kullanÄ±cÄ±)', color: '#94a3b8' },
            grid: { color: 'rgba(71, 85, 105, 0.5)' },
            ticks: { color: '#94a3b8' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            title: { display: true, text: 'SatÄ±ÅŸ (â‚¬)', color: '#94a3b8' },
            grid: { drawOnChartArea: false },
            ticks: { color: '#94a3b8' }
          },
          x: {
            grid: { color: 'rgba(71, 85, 105, 0.5)' },
            ticks: { color: '#94a3b8', maxRotation: 45 }
          }
        }
      }
    });
  }

  var badgeEl = document.getElementById('ai-badge');
  var detailEl = document.getElementById('ai-detail');
  var refreshBtn = document.getElementById('ai-refresh');
  if (!badgeEl || !detailEl) return;

  function setAIState(loading, ok, msg, detail) {
    if (loading) {
      badgeEl.textContent = 'Kontrol ediliyorâ€¦';
      badgeEl.className = 'text-lg font-semibold text-slate-400';
      detailEl.textContent = '';
      return;
    }
    if (ok) {
      badgeEl.innerHTML = 'ğŸŸ¢ Ã‡alÄ±ÅŸÄ±yor';
      badgeEl.className = 'text-lg font-semibold text-green-400';
      detailEl.textContent = detail || '';
      detailEl.className = 'text-sm text-slate-500 mt-1';
    } else {
      badgeEl.innerHTML = 'ğŸ”´ Sorun var';
      badgeEl.className = 'text-lg font-semibold text-red-400';
      detailEl.textContent = msg || 'AI eriÅŸilemedi.';
      detailEl.className = 'text-sm text-red-300 mt-1';
    }
  }

  function fetchAIHealth() {
    setAIState(true);
    fetch('/health/ai', { credentials: 'same-origin' })
      .then(function(res) { return res.json().then(function(data) { return { res: res, data: data }; }); })
      .then(function(r) {
        var data = r.data;
        var res = r.res;
        if (res.ok && data && data.status === 'ok') {
          var detail = data.latency_ms != null ? 'Gecikme: ' + data.latency_ms + ' ms' : '';
          setAIState(false, true, null, detail);
        } else {
          var errMsg = (data && data.error) ? data.error : (data && data.detail) ? (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail)) : 'YanÄ±t alÄ±namadÄ± (HTTP ' + (res.status || '') + ')';
          setAIState(false, false, errMsg);
        }
      })
      .catch(function(e) {
        setAIState(false, false, 'EriÅŸilemiyor: ' + (e.message || 'BaÄŸlantÄ± hatasÄ±'));
      });
  }

  if (refreshBtn) refreshBtn.addEventListener('click', function() { fetchAIHealth(); });
  fetchAIHealth();
  setInterval(fetchAIHealth, 60000);
})();
</script>
{% endblock %}

{% extends "admin/base_admin.html" %}
{% block title %}Ödeme #{{ order.id }} - Norya Admin{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold text-white mb-4">Ödeme Detayı</h1>
<div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-4 max-w-2xl">
  <p><span class="text-slate-400">ID:</span> {{ order.id }}</p>
  <p><span class="text-slate-400">merchant_oid:</span> <code class="text-sm">{{ order.merchant_oid }}</code></p>
  <p><span class="text-slate-400">Kullanıcı:</span> {{ user_email }} (ID: {{ order.user_id }})</p>
  <p><span class="text-slate-400">Ürün:</span> {{ order.product }}</p>
  <p><span class="text-slate-400">Tutar:</span> {{ "%.2f"|format(amount_eur) }} {{ order.currency }}</p>
  <p><span class="text-slate-400">Durum:</span> <span class="{% if order.status == 'completed' %}text-green-400{% elif order.status == 'failed' %}text-red-400{% else %}text-amber-400{% endif %}">{{ order.status }}</span></p>
  <p><span class="text-slate-400">İşlendi:</span> {% if order.is_processed %}Evet ({{ order.processed_at.strftime("%d.%m.%Y %H:%M") if order.processed_at else "-" }}){% else %}Hayır{% endif %}</p>
  <p><span class="text-slate-400">PayTR tx:</span> <code class="text-xs">{{ order.paytr_transaction_id or "-" }}</code></p>
  <p><span class="text-slate-400">Kupon:</span> {{ order.coupon_code_used or "-" }}</p>
  <p><span class="text-slate-400">Tarih:</span> {{ order.created_at.strftime("%d.%m.%Y %H:%M") if order.created_at else "-" }}</p>
  {% if invoice_ettn %}
  <p><span class="text-slate-400">E-arşiv fatura:</span> <span class="text-green-400">Kesildi</span> — ETTN: <code class="text-xs">{{ invoice_ettn }}</code></p>
  {% endif %}
</div>
{% if invoice_ok %}
<div class="mb-4 p-3 rounded-lg bg-green-900/40 border border-green-600 text-green-300 text-sm">E-arşiv fatura oluşturuldu. GİB portalında SMS ile onaylayabilirsiniz.</div>
{% endif %}
{% if invoice_err %}
<div class="mb-4 p-3 rounded-lg bg-red-900/40 border border-red-600 text-red-300 text-sm">{{ invoice_err }}</div>
{% endif %}
<form method="post" action="/admin/payments/{{ order.id }}/note" class="mb-4 max-w-2xl">
  <label class="block text-slate-400 text-sm mb-1">Admin notu (iade / açıklama)</label>
  <textarea name="admin_note" rows="3" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="İade veya not...">{{ admin_note }}</textarea>
  <div class="mt-2 flex gap-2">
    <button type="submit" class="px-4 py-2 rounded-lg bg-brand text-white">Kaydet</button>
    <a href="/admin/payments" class="px-4 py-2 rounded-lg bg-slate-600 text-white">Listeye dön</a>
  </div>
</form>

{% if order.status == 'completed' and not invoice_ettn %}
<section id="fatura" class="mt-6 max-w-2xl p-4 rounded-lg border border-slate-600 bg-slate-800/50">
  <h2 class="text-lg font-semibold text-white mb-3">E-arşiv fatura kes</h2>
  <p class="text-slate-400 text-sm mb-3">Alıcı bilgilerini girin; tutar siparişe göre TL’ye çevrilerek GİB’e gönderilir. GİB e-Arşiv Portal’da SMS ile onay gerekebilir.</p>
  <form method="post" action="/admin/payments/{{ order.id }}/invoice" class="space-y-3">
    <div>
      <label class="block text-slate-400 text-sm mb-1">Alıcı TC Kimlik No <span class="text-red-400">*</span></label>
      <input type="text" name="customer_tckn" required maxlength="11" pattern="[0-9]{10,11}" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="10 veya 11 hane">
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-slate-400 text-sm mb-1">Ad</label>
        <input type="text" name="customer_ad" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="Ad">
      </div>
      <div>
        <label class="block text-slate-400 text-sm mb-1">Soyad</label>
        <input type="text" name="customer_soyad" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="Soyad">
      </div>
    </div>
    <div>
      <label class="block text-slate-400 text-sm mb-1">Ünvan (opsiyonel)</label>
      <input type="text" name="customer_unvan" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="Şahıs için boş bırakılabilir">
    </div>
    <div>
      <label class="block text-slate-400 text-sm mb-1">Vergi dairesi (opsiyonel)</label>
      <input type="text" name="customer_vergi_dairesi" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="Örn: Kadıköy VD">
    </div>
    <div>
      <label class="block text-slate-400 text-sm mb-1">Fatura notu (opsiyonel)</label>
      <textarea name="fatura_notu" rows="2" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-white" placeholder="Ek açıklama"></textarea>
    </div>
    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white">E-arşiv fatura kes</button>
      <a href="/admin/payments" class="px-4 py-2 rounded-lg bg-slate-600 text-white">Listeye dön</a>
    </div>
  </form>
</section>
{% endif %}

{% endblock %}
